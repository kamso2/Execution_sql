<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs - SQL Executor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=2.1">
</head>

<body>

    <div class="dashboard-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span>SQL Execute</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-link">
                    <span class="icon">‚ö°</span> Ex√©cution
                </a>
                <a href="audit_view.html" id="navAuditLink" class="nav-link active">
                    <span class="icon">üìú</span> Audit Logs
                </a>
                <a href="admin_users.html" id="navUsersLink" class="nav-link">
                    <span class="icon">üë•</span> Utilisateurs
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <small>Connect√© en tant que</small>
                    <strong id="currentUser">Admin</strong>
                </div>
                <div class="sidebar-actions">
                    <button id="themeBtn" onclick="toggleTheme()" class="btn-icon" title="Th√®me">üåô</button>
                    <button onclick="window.location.href='index.html'" class="btn-icon logout"
                        title="Retour">‚¨Ö</button>
                </div>
            </div>
        </aside>

        <!-- CONTENU PRINCIPAL -->
        <main class="dashboard-content">
            <div class="main-container">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>Journal d'Audit</h1>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <div
                            style="display:flex; align-items:center; gap:5px; background:#fee2e2; padding:5px 10px; border-radius:6px; border:1px solid #fecaca;">
                            <span style="font-size:0.8rem; color:#991b1b; font-weight:600;">Purger avant le :</span>
                            <input type="date" id="purgeDate"
                                style="border:1px solid #fecaca; border-radius:4px; padding:2px;">
                            <button onclick="purgeLogs()"
                                style="background:#991b1b; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:0.8rem;">üóëÔ∏è</button>
                        </div>
                        <button class="refresh-btn" onclick="loadLogs()">Actualiser ‚ü≥</button>
                    </div>
                </div>

                <div class="card">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Utilisateur</th>
                                <th>Action (Query ID)</th>
                                <th>Table</th>
                                <th>IP</th>
                                <th>Statut</th>
                                <th>Lignes</th>
                                <th>Erreur</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align:center;">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Logique du th√®me
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const btn = document.getElementById('themeBtn');
            if (btn) {
                const isDark = document.body.classList.contains('dark-mode');
                btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Appliquer
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        document.addEventListener('DOMContentLoaded', updateThemeIcon);

        async function loadLogs() {
            const tbody = document.querySelector('#logsTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Chargement...</td></tr>';

            try {
                const res = await fetch('api_get_logs.php');

                if (res.status === 403) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">‚õî Acc√®s refus√©. R√©serv√© aux administrateurs.</td></tr>`;
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                const data = await res.json();

                // Nouvelle gestion d'erreur BDD
                if (res.status === 500 && data && data.is_db_error) {
                    window.location.href = 'maintenance.html';
                    return;
                }

                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Erreur: ${data.error}</td></tr>`;
                    return;
                }

                if (!data.logs || data.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Aucun log trouv√©.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                data.logs.forEach(log => {
                    const tr = document.createElement('tr');
                    const statusBadge = log.status === 'success'
                        ? '<span class="badge badge-success">Succ√®s</span>'
                        : '<span class="badge badge-error">Erreur</span>';

                    tr.innerHTML = `
                    <td>${log.timestamp}</td>
                    <td><b>${log.user}</b></td>
                    <td>${log.query_id}</td>
                    <td style="color:#2563eb;">${log.table_name || '-'}</td>
                    <td style="font-family:monospace; font-size:0.85em;">${log.remote_ip}</td>
                    <td>${statusBadge}</td>
                    <td>${log.row_count}</td>
                    <td style="color:#ef4444; font-size:0.9em;">${log.error || ''}</td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Erreur de connexion API</td></tr>`;
                console.error(err);
            }
        }

        async function purgeLogs() {
            const dateInput = document.getElementById('purgeDate');
            const date = dateInput.value;

            if (!date) {
                alert("Veuillez s√©lectionner une date limite.");
                return;
            }

            if (!confirm(`Etes-vous s√ªr de vouloir SUPPRIMER D√âFINITIVEMENT tous les logs ant√©rieurs au ${date} ?`)) {
                return;
            }

            try {
                const res = await fetch(`api_get_logs.php?action=purge&date=${date}`, { method: 'DELETE' });
                const data = await res.json();

                if (res.ok && data.success) {
                    alert(`Succ√®s : ${data.deleted_count} logs supprim√©s.`);
                    loadLogs();
                    dateInput.value = '';
                } else {
                    alert("Erreur : " + (data.error || "Inconnue"));
                }
            } catch (err) {
                alert("Erreur technique lors de la purge.");
                console.error(err);
            }
        }

        // Charger au d√©marrage
        window.addEventListener('DOMContentLoaded', loadLogs);
    </script>

</body>

</html>