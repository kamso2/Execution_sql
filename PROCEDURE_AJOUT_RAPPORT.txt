================================================================================
    PROCÃ‰DURE D'AJOUT D'UN NOUVEAU RAPPORT AVEC UNE NOUVELLE REQUÃŠTE
================================================================================

Date de crÃ©ation : 10 fÃ©vrier 2026
Version : 2.0
Application : Execution_SQL


================================================================================
TABLE DES MATIÃˆRES
================================================================================

1. Ã‰TAPES GÃ‰NÃ‰RALES
2. Ã‰TAPE 1 : AJOUTER LA REQUÃŠTE DANS LE BACKEND (PHP)
3. Ã‰TAPE 2 : AJOUTER LA REQUÃŠTE DANS LE FRONTEND (JAVASCRIPT)
4. Ã‰TAPE 3 : CONFIGURER LES PERMISSIONS (AUTORISATION PAR RÃ”LE)
5. Ã‰TAPE 4 : VÃ‰RIFICATION ET TEST
6. EXEMPLES DE REQUÃŠTES COURANTES


================================================================================
1. Ã‰TAPES GÃ‰NÃ‰RALES
================================================================================

Pour ajouter un nouveau rapport, vous devez modifier 3 fichiers principaux :
  1. includes/query_config.php  - Configuration backend de la requÃªte
  2. script.js                   - Interface utilisateur frontend
  3. includes/auth.php           - Permissions d'accÃ¨s par rÃ´le


================================================================================
2. Ã‰TAPE 1 : AJOUTER LA REQUÃŠTE DANS LE BACKEND (PHP)
================================================================================

Fichier : includes/query_config.php

Localisation : Lignes 38-77 (section "$queries")

Actions :
  1. Ouvrir le fichier includes/query_config.php
  2. Localiser l'array $queries (ligne 38)
  3. Ajouter votre nouvelle requÃªte AVANT la ligne de fermeture "];

--------------------------------------------------------------------------------
Structure d'une requÃªte :
--------------------------------------------------------------------------------

    "nom_de_la_requete" => [
        "template" => "SELECT/UPDATE/DELETE ... %table% ... :param",
        "replacement_maps" => [
            "table"            => $COMMON_TABLES,
            "columns"          => ["all" => "*"],
            "condition_column" => ["status" => "STATUS"],
            "date_column"      => $COMMON_DATE_MAP
        ],
        "allowed_values" => ['VALEUR1', 'VALEUR2'],  // Optionnel
        "pdo_params" => ["param1", "param2"]
    ],

--------------------------------------------------------------------------------
Explication des paramÃ¨tres :
--------------------------------------------------------------------------------

  - "nom_de_la_requete" : Identifiant unique (minuscules, underscores)
  - "template"          : RequÃªte SQL avec placeholders (%table%, :param)
  - "replacement_maps"  : Mapping des placeholders
  - "allowed_values"    : Valeurs autorisÃ©es (pour UPDATE/DELETE)
  - "pdo_params"        : ParamÃ¨tres PDO Ã  binder

--------------------------------------------------------------------------------
Exemple concret - Ajouter un rapport "EXPORT_CLIENTS" :
--------------------------------------------------------------------------------

    /**
     * Rapport : EXPORT CLIENTS (Nouveau)
     */
    "EXPORT_CLIENTS" => [
        "template" => "SELECT nom, prenom, telephone FROM %table% WHERE STATUS = :value",
        "replacement_maps" => [
            "table"            => $COMMON_TABLES,
            "condition_column" => ["status" => "STATUS"],
            "date_column"      => $COMMON_DATE_MAP
        ],
        "pdo_params" => ["value"]
    ],


================================================================================
3. Ã‰TAPE 2 : AJOUTER LA REQUÃŠTE DANS LE FRONTEND (JAVASCRIPT)
================================================================================

Fichier : script.js

Localisation : Lignes 1-50 (section "QUERY_CONFIGS")

Actions :
  1. Ouvrir le fichier script.js
  2. Localiser l'objet QUERY_CONFIGS (dÃ©but du fichier)
  3. Ajouter votre nouvelle requÃªte

--------------------------------------------------------------------------------
Structure d'une configuration frontend :
--------------------------------------------------------------------------------

    EXPORT_CLIENTS: {
        label: "ðŸ“Š Export Clients",
        requiresValue: true,
        requiresNewStatus: false,
        requiresDateFilter: false,
        allowedTables: "all"
    },

--------------------------------------------------------------------------------
Explication des paramÃ¨tres :
--------------------------------------------------------------------------------

  - label              : Texte affichÃ© dans l'interface (peut contenir emojis)
  - requiresValue      : true si la requÃªte nÃ©cessite un champ "Valeur"
  - requiresNewStatus  : true si la requÃªte nÃ©cessite un "Nouveau statut"
  - requiresDateFilter : true si la requÃªte nÃ©cessite un filtre de date
  - allowedTables      : "all" ou array de tables autorisÃ©es

--------------------------------------------------------------------------------
Exemple complet :
--------------------------------------------------------------------------------

    EXPORT_CLIENTS: {
        label: "ðŸ“Š Export Clients",
        requiresValue: true,           // NÃ©cessite un statut Ã  filtrer
        requiresNewStatus: false,      // Pas de mise Ã  jour de statut
        requiresDateFilter: true,      // Filtrer par date
        allowedTables: "all"           // Disponible pour toutes les tables
    },


================================================================================
4. Ã‰TAPE 3 : CONFIGURER LES PERMISSIONS (AUTORISATION PAR RÃ”LE)
================================================================================

Fichier : includes/auth.php

Localisation : Lignes 16-54 (constante "ROLE_PERMISSIONS")

Actions :
  1. Ouvrir le fichier includes/auth.php
  2. Localiser la constante ROLE_PERMISSIONS
  3. Ajouter votre requÃªte dans les rÃ´les appropriÃ©s

--------------------------------------------------------------------------------
Structure :
--------------------------------------------------------------------------------

    define('ROLE_PERMISSIONS', [
        'admin' => [
            'EXPORT_CLIENTS' => [
                'repeteurs', 'retour_echus', 'one_three_months', ...
            ],
        ],
        'user' => [
            'EXPORT_CLIENTS' => [
                'repeteurs', 'retour_echus'
            ],
        ],
    ]);

--------------------------------------------------------------------------------
RÃ¨gles :
--------------------------------------------------------------------------------

  - 'admin' : AccÃ¨s complet Ã  toutes les tables
  - 'user'  : AccÃ¨s limitÃ© (dÃ©finir les tables autorisÃ©es)

--------------------------------------------------------------------------------
Exemple :
--------------------------------------------------------------------------------

    'admin' => [
        'nombre_de_fiches' => [
            'repeteurs', 'retour_echus', 'one_three_months', ...
        ],
        'RELANCE' => [
            'repeteurs', 'retour_echus', 'one_three_months', ...
        ],
        'EXPORT_CLIENTS' => [  // NOUVEAU RAPPORT
            'repeteurs', 'retour_echus', 'one_three_months', ...
        ],
    ],


================================================================================
5. Ã‰TAPE 4 : VÃ‰RIFICATION ET TEST
================================================================================

--------------------------------------------------------------------------------
Checklist de vÃ©rification :
--------------------------------------------------------------------------------

  [ ] Le nom de la requÃªte est identique dans les 3 fichiers
  [ ] La syntaxe PHP est correcte (virgules, guillemets, crochets)
  [ ] La syntaxe JavaScript est correcte
  [ ] Les permissions sont dÃ©finies pour admin et user
  [ ] Les placeholders (%table%, :param) sont cohÃ©rents

--------------------------------------------------------------------------------
Tests Ã  effectuer :
--------------------------------------------------------------------------------

  1. RafraÃ®chir la page index.html (Ctrl+F5)
  2. VÃ©rifier que le nouveau rapport apparaÃ®t dans la liste dÃ©roulante
  3. SÃ©lectionner une table et exÃ©cuter le rapport
  4. VÃ©rifier que les rÃ©sultats s'affichent correctement
  5. Consulter audit_view.html pour vÃ©rifier l'enregistrement du log


================================================================================
6. EXEMPLES DE REQUÃŠTES COURANTES
================================================================================

--------------------------------------------------------------------------------
A. RequÃªte SELECT simple :
--------------------------------------------------------------------------------

    "LISTE_ACTIFS" => [
        "template" => "SELECT * FROM %table% WHERE STATUS = 'ACTIVE'",
        "replacement_maps" => [
            "table" => $COMMON_TABLES,
        ],
        "pdo_params" => []
    ],

Configuration frontend :

    LISTE_ACTIFS: {
        label: "ðŸ“‹ Liste des Actifs",
        requiresValue: false,
        requiresNewStatus: false,
        requiresDateFilter: false,
        allowedTables: "all"
    },

--------------------------------------------------------------------------------
B. RequÃªte UPDATE avec condition :
--------------------------------------------------------------------------------

    "ARCHIVER" => [
        "template" => "UPDATE %table% SET archived = 1 WHERE STATUS = :value",
        "replacement_maps" => [
            "table" => $COMMON_TABLES,
        ],
        "pdo_params" => ["value"]
    ],

Configuration frontend :

    ARCHIVER: {
        label: "ðŸ“¦ Archiver",
        requiresValue: true,
        requiresNewStatus: false,
        requiresDateFilter: false,
        allowedTables: "all"
    },

--------------------------------------------------------------------------------
C. RequÃªte avec filtre de date :
--------------------------------------------------------------------------------

    "CLIENTS_PAR_DATE" => [
        "template" => "SELECT * FROM %table% WHERE %date_column% BETWEEN :date_start AND :date_end",
        "replacement_maps" => [
            "table" => $COMMON_TABLES,
            "date_column" => $COMMON_DATE_MAP
        ],
        "pdo_params" => ["date_start", "date_end"]
    ],

Configuration frontend :

    CLIENTS_PAR_DATE: {
        label: "ðŸ“… Clients par Date",
        requiresValue: false,
        requiresNewStatus: false,
        requiresDateFilter: true,
        allowedTables: "all"
    },

--------------------------------------------------------------------------------
D. RequÃªte UPDATE avec nouveau statut :
--------------------------------------------------------------------------------

    "CHANGER_STATUT" => [
        "template" => "UPDATE %table% SET STATUS = :new_status WHERE STATUS = :value",
        "replacement_maps" => [
            "table" => $COMMON_TABLES,
        ],
        "allowed_values" => ['COMPLETED', 'NOT_DIALED', 'CALLBACK'],
        "pdo_params" => ["value", "new_status"]
    ],

Configuration frontend :

    CHANGER_STATUT: {
        label: "ðŸ”„ Changer Statut",
        requiresValue: true,
        requiresNewStatus: true,
        requiresDateFilter: false,
        allowedTables: "all"
    },


================================================================================
RÃ‰SUMÃ‰ DES FICHIERS Ã€ MODIFIER
================================================================================

+---------------------------+--------+------------------------------------------+
| Fichier                   | Lignes | Section                                  |
+---------------------------+--------+------------------------------------------+
| includes/query_config.php | 38-77  | Array $queries                           |
| script.js                 | 1-50   | Objet QUERY_CONFIGS                      |
| includes/auth.php         | 16-54  | Constante ROLE_PERMISSIONS               |
+---------------------------+--------+------------------------------------------+


================================================================================
NOTES IMPORTANTES
================================================================================

1. Le nom de la requÃªte doit Ãªtre IDENTIQUE dans les 3 fichiers
2. Respecter la syntaxe PHP et JavaScript (virgules, guillemets)
3. Toujours tester aprÃ¨s modification
4. Consulter les logs d'audit pour vÃ©rifier l'exÃ©cution
5. Voir le fichier BASE_2.md pour la gestion des tables (campagnes)


================================================================================
FIN DU DOCUMENT
================================================================================
